// Gleba - Schéma Prisma
// Migré depuis SQLite (Qt) vers PostgreSQL
// Voir ANALYSIS.md pour la documentation complète

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// AUTHENTIFICATION
// ============================================================

enum Role {
  ADMIN
  USER
}

/// Utilisateurs de l'application
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String    // bcrypt hash
  name          String?
  role          Role      @default(USER)
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // NextAuth sessions
  sessions      Session[]

  // Relations avec données utilisateur
  planches      Planche[]
  cultures      Culture[]
  recoltes      Recolte[]
  consommations Consommation[]
  irrigationsPlanifiees IrrigationPlanifiee[]
  fertilisations Fertilisation[]
  objetsJardin  ObjetJardin[]
  analysesSol   AnalyseSol[]
  notes         Note[]
  arbres        Arbre[]

  @@map("users")
}

/// Sessions NextAuth
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime

  @@map("sessions")
}

// ============================================================
// NIVEAU 1 - RÉFÉRENTIELS INDÉPENDANTS
// ============================================================

/// Familles botaniques (rotation des cultures)
model Famille {
  id          String   @id @map("famille")
  intervalle  Int      @default(4) @map("intervalle") // Années entre 2 cultures de même famille
  couleur     String?  @map("couleur") // Code couleur UI (#RRGGBB)
  description String?  @map("description")

  // Relations
  especes            Espece[]
  associationDetails AssociationDetail[]

  @@map("familles")
}

/// Fournisseurs de semences
model Fournisseur {
  id        String  @id @map("fournisseur")
  contact   String? @map("contact")
  adresse   String? @map("adresse")
  email     String? @map("email")
  telephone String? @map("telephone")
  siteWeb   String? @map("site_web")
  notes     String? @map("notes")

  // Relations
  varietes Variete[]

  @@map("fournisseurs")
}

/// Destinations des récoltes (vente, don, consommation)
model Destination {
  id          String  @id @map("destination")
  description String? @map("description")

  // Relations
  consommations Consommation[]

  @@map("destinations")
}

/// Fertilisants (engrais, amendements)
model Fertilisant {
  id          String  @id @map("fertilisant")
  type        String? @map("type") // Organique, Minéral, etc.
  n           Float?  @map("n") // Azote (%)
  p           Float?  @map("p") // Phosphore (%)
  k           Float?  @map("k") // Potassium (%)
  ca          Float?  @map("ca") // Calcium (%)
  mg          Float?  @map("mg") // Magnésium (%)
  s           Float?  @map("s") // Soufre (%)
  densite     Float?  @map("densite") // kg/L
  prix        Float?  @map("prix") // €/kg
  stock       Float?  @map("stock") // Quantité en stock (kg ou L)
  dateStock   DateTime? @map("date_stock")
  description String? @map("description")

  // Relations
  fertilisations Fertilisation[]

  @@map("fertilisants")
}

// ============================================================
// NIVEAU 2 - DÉPENDANTS DES RÉFÉRENTIELS
// ============================================================

/// Espèces de plantes cultivables
model Espece {
  id              String   @id @map("espece")
  type            String   @default("legume") @map("type") // legume, arbre_fruitier, petit_fruit, aromatique, engrais_vert
  familleId       String?  @map("famille")
  famille         Famille? @relation(fields: [familleId], references: [id], onDelete: SetNull)
  nomLatin        String?  @map("nom_latin")
  rendement       Float?   @map("rendement") // kg/m² ou kg/arbre
  vivace          Boolean  @default(false) @map("vivace")
  besoinN         Float?   @map("besoin_n") // Besoin azote (1-5)
  besoinP         Float?   @map("besoin_p") // Besoin phosphore (1-5)
  besoinK         Float?   @map("besoin_k") // Besoin potassium (1-5)
  besoinEau       Float?   @map("besoin_eau") // Besoin eau (1-5)
  dateInventaire  DateTime? @map("date_inventaire")
  inventaire      Float?   @map("inventaire") // Stock (kg)
  aPlanifier      Boolean  @default(true) @map("a_planifier")
  couleur         String?  @map("couleur") // Code couleur UI (#RRGGBB)
  description     String?  @map("description")

  // Nouveaux champs (parité Potaleger)
  categorie       String?  @map("categorie")       // Catégorie visuelle (emoji)
  niveau          String?  @map("niveau")          // Facile, Moyen, Difficile
  densite         Float?   @map("densite")         // Plants/m²
  doseSemis       Float?   @map("dose_semis")      // g/m²
  tauxGermination Float?   @map("taux_germination") // % germination
  temperatureGerm String?  @map("temp_germination") // Ex: "15-25°C"
  joursLevee      Int?     @map("jours_levee")     // Nombre de jours
  irrigation      String?  @map("irrigation")      // Faible/Moyen/Élevé
  conservation    Boolean? @map("conservation")    // Se conserve bien ?
  effet           String?  @map("effet")           // Effet sur le sol/autres
  usages          String?  @map("usages")          // Usages culinaires
  objectifAnnuel  Float?   @map("obj_annuel")      // kg ou unités visées/an
  prixKg          Float?   @map("prix_kg")         // Prix de vente €/kg
  semaineTaille   Int?     @map("s_taille")        // Semaine de taille (1-52)

  // Relations
  varietes           Variete[]
  cultures           Culture[]
  recoltes           Recolte[]
  consommations      Consommation[]
  itps               ITP[]
  arbres             Arbre[]
  associationDetails AssociationDetail[]

  @@map("especes")
}

/// Variétés (cultivars d'espèces)
model Variete {
  id             String       @id @map("variete")
  especeId       String       @map("espece")
  espece         Espece       @relation(fields: [especeId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  fournisseurId  String?      @map("fournisseur")
  fournisseur    Fournisseur? @relation(fields: [fournisseurId], references: [id], onDelete: SetNull)
  semaineRecolte Int?         @map("s_recolte") // Semaine récolte théorique (1-52)
  dureeRecolte   Int?         @map("d_recolte") // Durée période récolte (semaines)
  nbGrainesG     Float?       @map("nb_graines_g") // Nombre graines/gramme
  prixGraine     Float?       @map("prix_graine") // €/kg ou €/1000 graines
  stockGraines   Float?       @map("stock_graines") // Quantité graines en stock (g)
  stockPlants    Int?         @map("stock_plants")  // Quantité plants en stock
  dateStock      DateTime?    @map("date_stock")
  bio            Boolean      @default(false) @map("bio")
  description    String?      @map("description")

  // Relations
  cultures Culture[]

  @@map("varietes")
}

/// ITP - Itinéraires Techniques des Plantes
model ITP {
  id                String  @id @map("it_plante")
  especeId          String? @map("espece")
  espece            Espece? @relation(fields: [especeId], references: [id], onDelete: SetNull)
  semaineSemis      Int?    @map("s_semis") // Semaine semis (1-52)
  semainePlantation Int?    @map("s_plantation") // Semaine plantation (1-52)
  semaineRecolte    Int?    @map("s_recolte") // Semaine début récolte (1-52)
  dureeRecolte      Int?    @map("d_recolte") // Durée récolte (semaines, 1-52)
  dureePepiniere    Int?    @map("d_pepiniere") // Durée pépinière (jours)
  dureeCulture      Int?    @map("d_culture") // Durée culture (jours)
  nbRangs           Int?    @map("nb_rangs") // Nombre de rangs par planche
  espacement        Float?  @map("espacement") // Espacement entre plants (cm)
  notes             String? @map("notes")

  // Nouveaux champs (parité Potaleger)
  typePlanche     String?  @map("type_planche")     // Serre, Plein champ, Tunnel
  decalageMax     Int?     @map("decal_max")        // Semaines de flexibilité (0-52)
  espacementRangs Int?     @map("esp_rangs")        // cm entre rangs
  nbGrainesPlant  Float?   @map("nb_graines_plant") // Graines par plant
  doseSemis       Float?   @map("dose_semis")       // g/m² ou g/ml

  // Relations
  cultures         Culture[]
  rotationsDetails RotationDetail[]

  @@map("itps")
}

// ============================================================
// NIVEAU 3 - INFRASTRUCTURE SPATIALE ET TEMPORELLE
// ============================================================

/// Plans de rotation des cultures
model Rotation {
  id       String  @id @map("rotation")
  active   Boolean @default(true) @map("active")
  nbAnnees Int?    @map("nb_annees") // Calculé depuis les détails
  notes    String? @map("notes")

  // Relations
  details  RotationDetail[]
  planches Planche[]

  @@map("rotations")
}

/// Détails des rotations (années)
model RotationDetail {
  id         Int      @id @default(autoincrement())
  rotationId String   @map("rotation")
  rotation   Rotation @relation(fields: [rotationId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  itpId      String?  @map("it_plante")
  itp        ITP?     @relation(fields: [itpId], references: [id], onDelete: SetNull)
  annee      Int      @map("annee") // Position dans le cycle (1, 2, 3...)

  @@map("rotations_details")
}

/// Planches de culture (parcelles)
model Planche {
  id                  String    @id @map("planche")
  userId              String    @map("user_id")
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId          String?   @map("rotation")
  rotation            Rotation? @relation(fields: [rotationId], references: [id], onDelete: SetNull)
  largeur             Float?    @map("largeur") // mètres
  longueur            Float?    @map("longueur") // mètres
  surface             Float?    @map("surface") // m² (calculé: largeur × longueur)
  // Position sur le plan du jardin
  posX                Float?    @map("pos_x") // Position X en mètres
  posY                Float?    @map("pos_y") // Position Y en mètres
  rotation2D          Float?    @default(0) @map("rotation_2d") // Rotation en degrés
  planchesInfluencees String?   @map("planches_influencees") // CSV des planches proches (associations)
  ilot                String?   @map("ilot") // Groupement de planches
  notes               String?   @map("notes")

  // Nouveaux champs (parité Potaleger)
  type                String?   @map("type")       // Serre, Plein champ, Tunnel, Châssis
  irrigation          String?   @map("irrigation") // Goutte-à-goutte, Aspersion, Manuel, Aucun
  annee               Int?      @map("annee")      // Année de référence pour rotation

  // Relations
  cultures       Culture[]
  fertilisations Fertilisation[]
  analyses       AnalyseSol[]

  @@index([userId])
  @@index([userId, ilot])
  @@map("planches")
}

/// Analyses de sol
model AnalyseSol {
  id            String    @id @map("analyse")
  userId        String    @map("user_id")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plancheId     String?   @map("planche")
  planche       Planche?  @relation(fields: [plancheId], references: [id], onDelete: SetNull)
  dateAnalyse   DateTime? @map("date_analyse")
  laboratoire   String?   @map("laboratoire")
  // Texture
  argile        Float?    @map("argile") // %
  limon         Float?    @map("limon") // %
  sable         Float?    @map("sable") // %
  // Chimie
  ph            Float?    @map("ph")
  matiereOrg    Float?    @map("mo") // Matière organique %
  cec           Float?    @map("cec") // Capacité d'échange cationique
  // Éléments majeurs
  n             Float?    @map("n") // Azote total
  p             Float?    @map("p") // Phosphore assimilable (Olsen)
  k             Float?    @map("k") // Potassium échangeable
  ca            Float?    @map("ca") // Calcium échangeable
  mg            Float?    @map("mg") // Magnésium échangeable
  na            Float?    @map("na") // Sodium échangeable
  // Oligo-éléments
  fe            Float?    @map("fe") // Fer
  mn            Float?    @map("mn") // Manganèse
  cu            Float?    @map("cu") // Cuivre
  zn            Float?    @map("zn") // Zinc
  b             Float?    @map("b") // Bore
  notes         String?   @map("notes")

  @@map("analyses_de_sol")
}

// ============================================================
// NIVEAU 4 - OPÉRATIONNEL (TRANSACTIONS)
// ============================================================

/// Cultures (instances de semis/plantation)
model Culture {
  id              Int       @id @default(autoincrement())
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  especeId        String    @map("espece")
  espece          Espece    @relation(fields: [especeId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  varieteId       String?   @map("variete")
  variete         Variete?  @relation(fields: [varieteId], references: [id], onDelete: SetNull)
  itpId           String?   @map("it_plante")
  itp             ITP?      @relation(fields: [itpId], references: [id], onDelete: SetNull)
  plancheId       String?   @map("planche")
  planche         Planche?  @relation(fields: [plancheId], references: [id], onDelete: SetNull)

  // Planification
  annee           Int?      @map("annee") // Année de planification
  dateSemis       DateTime? @map("date_semis")
  datePlantation  DateTime? @map("date_plantation")
  dateRecolte     DateTime? @map("date_recolte")

  // État d'avancement
  semisFait       Boolean   @default(false) @map("semis_fait")
  plantationFaite Boolean   @default(false) @map("plantation_faite")
  recolteFaite    Boolean   @default(false) @map("recolte_faite")
  terminee        String?   @map("terminee") // NULL, 'x' (terminée), 'v' (vivace continue), 'NS' (non significative)

  // Quantités
  quantite        Float?    @map("quantite") // Surface ou nb plants
  nbRangs         Int?      @map("nb_rangs")
  longueur        Float?    @map("longueur") // mètres
  espacement      Int?      @map("espacement") // cm entre plants

  // Nouveaux champs (parité Potaleger)
  finRecolte          DateTime? @map("fin_recolte") // Date fin récolte
  aFaire              String?   @map("a_faire")     // Tâches à faire
  dPlanif             String?   @map("d_planif")    // Date de planification
  aIrriguer           Boolean?  @map("a_irriguer")  // Besoin d'irrigation
  derniereIrrigation  DateTime? @map("derniere_irrigation") // Dernière date d'arrosage

  notes           String?   @map("notes")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  recoltes Recolte[]
  irrigationsPlanifiees IrrigationPlanifiee[]

  @@index([userId])
  @@index([userId, annee])
  @@index([especeId])
  @@index([plancheId])
  @@index([dateSemis])
  @@index([datePlantation])
  @@index([dateRecolte])
  @@index([aIrriguer])
  @@map("cultures")
}

/// Récoltes
model Recolte {
  id         Int      @id @default(autoincrement())
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  especeId   String   @map("espece")
  espece     Espece   @relation(fields: [especeId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  cultureId  Int      @map("culture")
  culture    Culture  @relation(fields: [cultureId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  date       DateTime @default(now()) @map("date")
  quantite   Float    @map("quantite") // kg
  notes      String?  @map("notes")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([especeId])
  @@index([cultureId])
  @@index([date])
  @@map("recoltes")
}

/// Irrigations planifiées
model IrrigationPlanifiee {
  id             Int      @id @default(autoincrement())
  userId         String   @map("user_id")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cultureId      Int      @map("culture_id")
  culture        Culture  @relation(fields: [cultureId], references: [id], onDelete: Cascade)
  datePrevue     DateTime @map("date_prevue")
  fait           Boolean  @default(false) @map("fait")
  dateEffective  DateTime? @map("date_effective") // Date réelle si différente
  notes          String?  @map("notes") @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([cultureId])
  @@index([datePrevue])
  @@map("irrigations_planifiees")
}

/// Consommations (sorties de stock)
model Consommation {
  id            Int          @id @default(autoincrement())
  userId        String       @map("user_id")
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  especeId      String       @map("espece")
  espece        Espece       @relation(fields: [especeId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  destinationId String?      @map("destination")
  destination   Destination? @relation(fields: [destinationId], references: [id], onDelete: SetNull)
  date          DateTime     @default(now()) @map("date")
  quantite      Float        @map("quantite") // kg
  prix          Float?       @map("prix") // € total
  notes         String?      @map("notes")
  createdAt     DateTime     @default(now()) @map("created_at")

  @@index([userId])
  @@index([especeId])
  @@index([date])
  @@map("consommations")
}

/// Fertilisations (apports)
model Fertilisation {
  id            Int         @id @default(autoincrement())
  userId        String      @map("user_id")
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  plancheId     String      @map("planche")
  planche       Planche     @relation(fields: [plancheId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  fertilisantId String      @map("fertilisant")
  fertilisant   Fertilisant @relation(fields: [fertilisantId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  date          DateTime    @default(now()) @map("date")
  quantite      Float       @map("quantite") // kg ou L
  notes         String?     @map("notes")
  createdAt     DateTime    @default(now()) @map("created_at")

  @@map("fertilisations")
}

/// Notes générales
model Note {
  id        Int      @id @default(autoincrement())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  titre     String?  @map("titre")
  contenu   String?  @map("contenu") // Markdown
  categorie String?  @map("categorie") // Catégorie libre
  date      DateTime @default(now()) @map("date")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("notes")
}

/// Paramètres de l'application
model Parametre {
  id     String  @id @map("parametre")
  valeur String? @map("valeur")

  @@map("params")
}

/// Objets du jardin (allées, passages, bordures, serres, etc.)
model ObjetJardin {
  id          Int      @id @default(autoincrement())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  nom         String?  @map("nom")
  type        String   @map("type") // "allee", "passage", "bordure", "serre", "compost", "autre"
  largeur     Float    @map("largeur") // mètres
  longueur    Float    @map("longueur") // mètres
  posX        Float    @map("pos_x") // Position X en mètres
  posY        Float    @map("pos_y") // Position Y en mètres
  rotation2D  Float    @default(0) @map("rotation_2d") // Rotation en degrés
  couleur     String?  @map("couleur") // Code couleur (#RRGGBB)
  notes       String?  @map("notes")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("objets_jardin")
}

/// Arbres et arbustes (fruitiers, petits fruits, ornementaux)
model Arbre {
  id              Int       @id @default(autoincrement())
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  nom             String    @map("nom") // Nom d'affichage (ex: "Pommier Golden")
  type            String    @map("type") // "fruitier", "petit_fruit", "ornement", "haie"
  especeId        String?   @map("espece_id") // Lien optionnel vers le catalogue Espece
  especeRef       Espece?   @relation(fields: [especeId], references: [id], onDelete: SetNull)
  espece          String?   @map("espece") // Espèce texte libre (ex: "Pommier", "Framboisier")
  variete         String?   @map("variete") // Variété (ex: "Golden", "Malling Promise")
  portGreffe      String?   @map("port_greffe") // Porte-greffe si applicable
  fournisseur     String?   @map("fournisseur") // Lieu d'achat / pépinière
  dateAchat       DateTime? @map("date_achat")
  datePlantation  DateTime? @map("date_plantation")
  age             Int?      @map("age") // Âge à la plantation (années)
  // Position sur le plan
  posX            Float     @map("pos_x")
  posY            Float     @map("pos_y")
  envergure       Float     @default(2) @map("envergure") // Diamètre en mètres (pour affichage)
  // Infos complémentaires
  hauteur         Float?    @map("hauteur") // Hauteur actuelle en mètres
  etat            String?   @map("etat") // "excellent", "bon", "moyen", "mauvais", "mort"
  pollinisateur   String?   @map("pollinisateur") // Variété pollinisatrice associée
  couleur         String?   @map("couleur") // Couleur d'affichage sur le plan
  notes           String?   @map("notes")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("arbres")
}

// ============================================================
// ASSOCIATIONS DE PLANTES (COMPAGNONNAGE)
// ============================================================

/// Associations de plantes (compagnonnage)
model Association {
  id          String  @id // Ex: "asso-tomate-basilic"
  nom         String  // Ex: "Tomates-Basilic"
  description String?
  notes       String?

  // Relations
  details AssociationDetail[]

  @@map("associations")
}

/// Détails des associations (espèces/familles associées)
model AssociationDetail {
  id            Int          @id @default(autoincrement())
  associationId String       @map("association_id")
  association   Association  @relation(fields: [associationId], references: [id], onDelete: Cascade)
  especeId      String?      @map("espece")
  espece        Espece?      @relation(fields: [especeId], references: [id], onDelete: SetNull)
  familleId     String?      @map("famille")
  famille       Famille?     @relation(fields: [familleId], references: [id], onDelete: SetNull)
  groupe        String?      @map("groupe") // Groupe libre (ex: "Liliacées")
  requise       Boolean      @default(false) @map("requise") // Association requise ou bénéfique
  notes         String?      @map("notes")

  @@map("associations_details")
}

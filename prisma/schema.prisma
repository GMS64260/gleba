// Gleba - Schéma Prisma
// Migré depuis SQLite (Qt) vers PostgreSQL
// Voir ANALYSIS.md pour la documentation complète

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// AUTHENTIFICATION
// ============================================================

enum Role {
  ADMIN
  USER
}

/// Utilisateurs de l'application
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String    // bcrypt hash
  name          String?
  role          Role      @default(USER)
  active        Boolean   @default(true)
  apiToken      String?   @unique @map("api_token")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // NextAuth sessions
  sessions      Session[]

  // Relations avec données utilisateur
  planches      Planche[]
  cultures      Culture[]
  recoltes      Recolte[]
  consommations Consommation[]
  irrigationsPlanifiees IrrigationPlanifiee[]
  fertilisations Fertilisation[]
  objetsJardin  ObjetJardin[]
  analysesSol   AnalyseSol[]
  notes         Note[]
  arbres        Arbre[]

  // Relations module arbres
  recoltesArbres    RecolteArbre[]
  productionsBois   ProductionBois[]
  operationsArbres  OperationArbre[]

  // Relations module élevage
  animaux               Animal[]
  lotsAnimaux           LotAnimaux[]
  productionsOeufs      ProductionOeuf[]
  ventesProduits        VenteProduit[]
  abattages             Abattage[]
  consommationsAliments ConsommationAliment[]
  soinsAnimaux          SoinAnimal[]
  naissancesAnimales    NaissanceAnimale[]

  // Relations module comptabilité
  ventesManuelles       VenteManuelle[]
  depensesManuelles     DepenseManuelle[]
  clients               Client[]
  facturesEmises        Facture[]

  // Relations stocks per-user (multi-tenancy)
  userStockVarietes     UserStockVariete[]
  userStockFertilisants UserStockFertilisant[]
  userStockAliments     UserStockAliment[]
  userStockEspeces      UserStockEspece[]

  // Relations chat IA
  conversations         Conversation[]

  @@map("users")
}

/// Sessions NextAuth
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime

  @@map("sessions")
}

// ============================================================
// NIVEAU 1 - RÉFÉRENTIELS INDÉPENDANTS
// ============================================================

/// Familles botaniques (rotation des cultures)
model Famille {
  id          String   @id @map("famille")
  intervalle  Int      @default(4) @map("intervalle") // Années entre 2 cultures de même famille
  couleur     String?  @map("couleur") // Code couleur UI (#RRGGBB)
  description String?  @map("description")

  // Relations
  especes            Espece[]
  associationDetails AssociationDetail[]

  @@map("familles")
}

/// Fournisseurs (semences, aliments, animaux)
model Fournisseur {
  id                 String   @id @map("fournisseur")
  contact            String?  @map("contact")
  adresse            String?  @map("adresse")
  ville              String?  @map("ville")
  codePostal         String?  @map("code_postal")
  pays               String?  @default("France") @map("pays")
  email              String?  @map("email")
  telephone          String?  @map("telephone")
  siteWeb            String?  @map("site_web")
  siret              String?  @map("siret")
  tvaIntra           String?  @map("tva_intra") // Numéro TVA intracommunautaire
  type               String?  @map("type") // "semences", "aliments", "animaux", "materiel", "mixte"
  conditionsPaiement Int?     @default(30) @map("conditions_paiement") // Délai paiement en jours
  notes              String?  @map("notes")
  actif              Boolean  @default(true) @map("actif")
  createdAt          DateTime @default(now()) @map("created_at")

  // Relations
  varietes  Variete[]
  aliments  Aliment[]

  @@map("fournisseurs")
}

/// Destinations des récoltes et ventes (vente, don, consommation)
model Destination {
  id          String  @id @map("destination")
  description String? @map("description")

  // Relations
  consommations  Consommation[]
  ventesProduits VenteProduit[]

  @@map("destinations")
}

/// Fertilisants (engrais, amendements)
model Fertilisant {
  id          String  @id @map("fertilisant")
  type        String? @map("type") // Organique, Minéral, etc.
  n           Float?  @map("n") // Azote (%)
  p           Float?  @map("p") // Phosphore (%)
  k           Float?  @map("k") // Potassium (%)
  ca          Float?  @map("ca") // Calcium (%)
  mg          Float?  @map("mg") // Magnésium (%)
  s           Float?  @map("s") // Soufre (%)
  densite     Float?  @map("densite") // kg/L
  prix        Float?  @map("prix") // €/kg
  stock       Float?  @map("stock") // Quantité en stock (kg ou L)
  dateStock   DateTime? @map("date_stock")
  description String? @map("description")

  // Relations
  fertilisations Fertilisation[]
  userStocks     UserStockFertilisant[]

  @@map("fertilisants")
}

// ============================================================
// NIVEAU 2 - DÉPENDANTS DES RÉFÉRENTIELS
// ============================================================

/// Espèces de plantes cultivables
model Espece {
  id              String   @id @map("espece")
  type            String   @default("legume") @map("type") // legume, arbre_fruitier, petit_fruit, aromatique, engrais_vert
  familleId       String?  @map("famille")
  famille         Famille? @relation(fields: [familleId], references: [id], onDelete: SetNull)
  nomLatin        String?  @map("nom_latin")
  rendement       Float?   @map("rendement") // kg/m² ou kg/arbre
  vivace          Boolean  @default(false) @map("vivace")
  besoinN         Float?   @map("besoin_n") // Besoin azote (1-5)
  besoinP         Float?   @map("besoin_p") // Besoin phosphore (1-5)
  besoinK         Float?   @map("besoin_k") // Besoin potassium (1-5)
  besoinEau       Float?   @map("besoin_eau") // Besoin eau (1-5)
  dateInventaire  DateTime? @map("date_inventaire")
  inventaire      Float?   @map("inventaire") // Stock (kg)
  aPlanifier      Boolean  @default(true) @map("a_planifier")
  couleur         String?  @map("couleur") // Code couleur UI (#RRGGBB)
  description     String?  @map("description")

  // Nouveaux champs (parité Potaleger)
  categorie       String?  @map("categorie")       // Catégorie visuelle (emoji)
  niveau          String?  @map("niveau")          // Facile, Moyen, Difficile
  densite         Float?   @map("densite")         // Plants/m²
  doseSemis       Float?   @map("dose_semis")      // g/m²
  tauxGermination Float?   @map("taux_germination") // % germination
  temperatureGerm String?  @map("temp_germination") // Ex: "15-25°C"
  joursLevee      Int?     @map("jours_levee")     // Nombre de jours
  irrigation      String?  @map("irrigation")      // Faible/Moyen/Élevé
  conservation    Boolean? @map("conservation")    // Se conserve bien ?
  effet           String?  @map("effet")           // Effet sur le sol/autres
  usages          String?  @map("usages")          // Usages culinaires
  objectifAnnuel  Float?   @map("obj_annuel")      // kg ou unités visées/an
  prixKg          Float?   @map("prix_kg")         // Prix de vente €/kg
  semaineTaille   Int?     @map("s_taille")        // Semaine de taille (1-52)

  // Relations
  varietes           Variete[]
  cultures           Culture[]
  recoltes           Recolte[]
  consommations      Consommation[]
  itps               ITP[]
  arbres             Arbre[]
  associationDetails AssociationDetail[]
  userStocks         UserStockEspece[]

  @@map("especes")
}

/// Variétés (cultivars d'espèces)
model Variete {
  id             String       @id @map("variete")
  especeId       String       @map("espece")
  espece         Espece       @relation(fields: [especeId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  fournisseurId  String?      @map("fournisseur")
  fournisseur    Fournisseur? @relation(fields: [fournisseurId], references: [id], onDelete: SetNull)
  semaineRecolte Int?         @map("s_recolte") // Semaine récolte théorique (1-52)
  dureeRecolte   Int?         @map("d_recolte") // Durée période récolte (semaines)
  nbGrainesG     Float?       @map("nb_graines_g") // Nombre graines/gramme
  prixGraine     Float?       @map("prix_graine") // €/kg ou €/1000 graines
  stockGraines   Float?       @map("stock_graines") // Quantité graines en stock (g)
  stockPlants    Int?         @map("stock_plants")  // Quantité plants en stock
  dateStock      DateTime?    @map("date_stock")
  bio            Boolean      @default(false) @map("bio")
  description    String?      @map("description")

  // Relations
  cultures         Culture[]
  userStocks       UserStockVariete[]

  @@map("varietes")
}

/// ITP - Itinéraires Techniques des Plantes
model ITP {
  id                String  @id @map("it_plante")
  especeId          String? @map("espece")
  espece            Espece? @relation(fields: [especeId], references: [id], onDelete: SetNull)
  semaineSemis      Int?    @map("s_semis") // Semaine semis (1-52)
  semainePlantation Int?    @map("s_plantation") // Semaine plantation (1-52)
  semaineRecolte    Int?    @map("s_recolte") // Semaine début récolte (1-52)
  dureeRecolte      Int?    @map("d_recolte") // Durée récolte (semaines, 1-52)
  dureePepiniere    Int?    @map("d_pepiniere") // Durée pépinière (jours)
  dureeCulture      Int?    @map("d_culture") // Durée culture (jours)
  nbRangs           Int?    @map("nb_rangs") // Nombre de rangs par planche
  espacement        Float?  @map("espacement") // Espacement entre plants (cm)
  notes             String? @map("notes")

  // Nouveaux champs (parité Potaleger)
  typePlanche     String?  @map("type_planche")     // Serre, Plein champ, Tunnel
  decalageMax     Int?     @map("decal_max")        // Semaines de flexibilité (0-52)
  espacementRangs Int?     @map("esp_rangs")        // cm entre rangs
  nbGrainesPlant  Float?   @map("nb_graines_plant") // Graines par plant
  doseSemis       Float?   @map("dose_semis")       // g/m² ou g/ml

  // Relations
  cultures         Culture[]
  rotationsDetails RotationDetail[]

  @@map("itps")
}

// ============================================================
// NIVEAU 3 - INFRASTRUCTURE SPATIALE ET TEMPORELLE
// ============================================================

/// Plans de rotation des cultures
model Rotation {
  id       String  @id @map("rotation")
  active   Boolean @default(true) @map("active")
  nbAnnees Int?    @map("nb_annees") // Calculé depuis les détails
  notes    String? @map("notes")

  // Relations
  details  RotationDetail[]
  planches Planche[]

  @@map("rotations")
}

/// Détails des rotations (années)
model RotationDetail {
  id         Int      @id @default(autoincrement())
  rotationId String   @map("rotation")
  rotation   Rotation @relation(fields: [rotationId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  itpId      String?  @map("it_plante")
  itp        ITP?     @relation(fields: [itpId], references: [id], onDelete: SetNull)
  annee      Int      @map("annee") // Position dans le cycle (1, 2, 3...)

  @@map("rotations_details")
}

/// Planches de culture (parcelles)
model Planche {
  id                  String    @id @default(cuid())
  nom                 String    @map("nom")
  userId              String    @map("user_id")
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId          String?   @map("rotation")
  rotation            Rotation? @relation(fields: [rotationId], references: [id], onDelete: SetNull)
  largeur             Float?    @map("largeur") // mètres
  longueur            Float?    @map("longueur") // mètres
  surface             Float?    @map("surface") // m² (calculé: largeur × longueur)
  // Position sur le plan du jardin
  posX                Float?    @map("pos_x") // Position X en mètres
  posY                Float?    @map("pos_y") // Position Y en mètres
  rotation2D          Float?    @default(0) @map("rotation_2d") // Rotation en degrés
  planchesInfluencees String?   @map("planches_influencees") // CSV des planches proches (associations)
  ilot                String?   @map("ilot") // Groupement de planches
  notes               String?   @map("notes")

  // Nouveaux champs (parité Potaleger)
  type                String?   @map("type")       // Serre, Plein champ, Tunnel, Châssis
  irrigation          String?   @map("irrigation") // Goutte-à-goutte, Aspersion, Manuel, Aucun
  annee               Int?      @map("annee")      // Année de référence pour rotation

  // Qualité du sol (influence irrigation/fertilisation)
  typeSol             String?   @map("type_sol")         // Argileux, Limoneux, Sableux, Mixte
  retentionEau        String?   @map("retention_eau")    // Faible, Moyenne, Élevée
  argile              Float?    @map("argile_pct")       // % argile (0-100)
  limon               Float?    @map("limon_pct")        // % limon
  sable               Float?    @map("sable_pct")        // % sable
  phSol               Float?    @map("ph_sol")           // pH du sol
  carboneOrg          Float?    @map("carbone_org")      // % carbone organique
  derniereAnalyseSol  DateTime? @map("derniere_analyse") // Date dernière maj données sol

  // Relations
  cultures       Culture[]
  fertilisations Fertilisation[]
  analyses       AnalyseSol[]

  @@unique([nom, userId])
  @@index([userId])
  @@index([userId, ilot])
  @@map("planches")
}

/// Analyses de sol
model AnalyseSol {
  id            String    @id @default(cuid())
  nom           String    @map("nom")
  userId        String    @map("user_id")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plancheId     String?   @map("planche")
  planche       Planche?  @relation(fields: [plancheId], references: [id], onDelete: SetNull)
  dateAnalyse   DateTime? @map("date_analyse")
  laboratoire   String?   @map("laboratoire")
  // Texture
  argile        Float?    @map("argile") // %
  limon         Float?    @map("limon") // %
  sable         Float?    @map("sable") // %
  // Chimie
  ph            Float?    @map("ph")
  matiereOrg    Float?    @map("mo") // Matière organique %
  cec           Float?    @map("cec") // Capacité d'échange cationique
  // Éléments majeurs
  n             Float?    @map("n") // Azote total
  p             Float?    @map("p") // Phosphore assimilable (Olsen)
  k             Float?    @map("k") // Potassium échangeable
  ca            Float?    @map("ca") // Calcium échangeable
  mg            Float?    @map("mg") // Magnésium échangeable
  na            Float?    @map("na") // Sodium échangeable
  // Oligo-éléments
  fe            Float?    @map("fe") // Fer
  mn            Float?    @map("mn") // Manganèse
  cu            Float?    @map("cu") // Cuivre
  zn            Float?    @map("zn") // Zinc
  b             Float?    @map("b") // Bore
  notes         String?   @map("notes")

  @@unique([nom, userId])
  @@index([userId])
  @@index([plancheId])
  @@map("analyses_de_sol")
}

// ============================================================
// NIVEAU 4 - OPÉRATIONNEL (TRANSACTIONS)
// ============================================================

/// Cultures (instances de semis/plantation)
model Culture {
  id              Int       @id @default(autoincrement())
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  especeId        String    @map("espece")
  espece          Espece    @relation(fields: [especeId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  varieteId       String?   @map("variete")
  variete         Variete?  @relation(fields: [varieteId], references: [id], onDelete: SetNull)
  itpId           String?   @map("it_plante")
  itp             ITP?      @relation(fields: [itpId], references: [id], onDelete: SetNull)
  plancheId       String?   @map("planche")
  planche         Planche?  @relation(fields: [plancheId], references: [id], onDelete: SetNull)

  // Planification
  annee           Int?      @map("annee") // Année de planification
  dateSemis       DateTime? @map("date_semis")
  datePlantation  DateTime? @map("date_plantation")
  dateRecolte     DateTime? @map("date_recolte")

  // État d'avancement
  semisFait       Boolean   @default(false) @map("semis_fait")
  plantationFaite Boolean   @default(false) @map("plantation_faite")
  recolteFaite    Boolean   @default(false) @map("recolte_faite")
  terminee        String?   @map("terminee") // NULL, 'x' (terminée), 'v' (vivace continue), 'NS' (non significative)

  // Quantités
  quantite        Float?    @map("quantite") // Surface ou nb plants
  nbRangs         Int?      @map("nb_rangs")
  longueur        Float?    @map("longueur") // mètres
  espacement      Int?      @map("espacement") // cm entre plants

  // Nouveaux champs (parité Potaleger)
  finRecolte          DateTime? @map("fin_recolte") // Date fin récolte
  aFaire              String?   @map("a_faire")     // Tâches à faire
  dPlanif             String?   @map("d_planif")    // Date de planification
  aIrriguer           Boolean?  @map("a_irriguer")  // Besoin d'irrigation
  derniereIrrigation  DateTime? @map("derniere_irrigation") // Dernière date d'arrosage

  notes           String?   @map("notes")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  recoltes Recolte[]
  irrigationsPlanifiees IrrigationPlanifiee[]

  @@index([userId])
  @@index([userId, annee])
  @@index([especeId])
  @@index([plancheId])
  @@index([dateSemis])
  @@index([datePlantation])
  @@index([dateRecolte])
  @@index([aIrriguer])
  @@map("cultures")
}

/// Récoltes
model Recolte {
  id             Int       @id @default(autoincrement())
  userId         String    @map("user_id")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  especeId       String    @map("espece")
  espece         Espece    @relation(fields: [especeId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  cultureId      Int       @map("culture")
  culture        Culture   @relation(fields: [cultureId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  date           DateTime  @default(now()) @map("date")
  quantite       Float     @map("quantite") // kg
  // Statut et vente
  statut         String    @default("en_stock") @map("statut") // "en_stock", "vendu", "consomme", "perte"
  dateVente      DateTime? @map("date_vente")
  prixKg         Float?    @map("prix_kg")
  prixTotal      Float?    @map("prix_total")
  clientId       Int?      @map("client_id")
  clientNom      String?   @map("client_nom")
  factureId      Int?      @map("facture_id")
  // Péremption (pour sortie auto du stock)
  datePeremption DateTime? @map("date_peremption") // Date limite avant que le produit soit périmé
  notes          String?   @map("notes")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([especeId])
  @@index([cultureId])
  @@index([cultureId, date])
  @@index([date])
  @@index([statut])
  @@map("recoltes")
}

/// Irrigations planifiées
model IrrigationPlanifiee {
  id             Int      @id @default(autoincrement())
  userId         String   @map("user_id")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cultureId      Int      @map("culture_id")
  culture        Culture  @relation(fields: [cultureId], references: [id], onDelete: Cascade)
  datePrevue     DateTime @map("date_prevue")
  fait           Boolean  @default(false) @map("fait")
  dateEffective  DateTime? @map("date_effective") // Date réelle si différente
  notes          String?  @map("notes") @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([cultureId])
  @@index([datePrevue])
  @@map("irrigations_planifiees")
}

/// Consommations (sorties de stock)
model Consommation {
  id            Int          @id @default(autoincrement())
  userId        String       @map("user_id")
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  especeId      String       @map("espece")
  espece        Espece       @relation(fields: [especeId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  destinationId String?      @map("destination")
  destination   Destination? @relation(fields: [destinationId], references: [id], onDelete: SetNull)
  date          DateTime     @default(now()) @map("date")
  quantite      Float        @map("quantite") // kg
  prix          Float?       @map("prix") // € total
  notes         String?      @map("notes")
  createdAt     DateTime     @default(now()) @map("created_at")

  @@index([userId])
  @@index([especeId])
  @@index([date])
  @@map("consommations")
}

/// Fertilisations (apports)
model Fertilisation {
  id            Int         @id @default(autoincrement())
  userId        String      @map("user_id")
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  plancheId     String      @map("planche")
  planche       Planche     @relation(fields: [plancheId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  fertilisantId String      @map("fertilisant")
  fertilisant   Fertilisant @relation(fields: [fertilisantId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  date          DateTime    @default(now()) @map("date")
  quantite      Float       @map("quantite") // kg ou L
  notes         String?     @map("notes")
  createdAt     DateTime    @default(now()) @map("created_at")

  @@index([userId])
  @@index([userId, date])
  @@index([plancheId, date])
  @@map("fertilisations")
}

/// Notes générales
model Note {
  id        Int      @id @default(autoincrement())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  titre     String?  @map("titre")
  contenu   String?  @map("contenu") // Markdown
  categorie String?  @map("categorie") // Catégorie libre
  date      DateTime @default(now()) @map("date")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("notes")
}

/// Paramètres de l'application
model Parametre {
  id     String  @id @map("parametre")
  valeur String? @map("valeur")

  @@map("params")
}

/// Objets du jardin (allées, passages, bordures, serres, etc.)
model ObjetJardin {
  id          Int      @id @default(autoincrement())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  nom         String?  @map("nom")
  type        String   @map("type") // "allee", "passage", "bordure", "serre", "compost", "autre"
  largeur     Float    @map("largeur") // mètres
  longueur    Float    @map("longueur") // mètres
  posX        Float    @map("pos_x") // Position X en mètres
  posY        Float    @map("pos_y") // Position Y en mètres
  rotation2D  Float    @default(0) @map("rotation_2d") // Rotation en degrés
  couleur     String?  @map("couleur") // Code couleur (#RRGGBB)
  notes       String?  @map("notes")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("objets_jardin")
}

/// Arbres et arbustes (fruitiers, petits fruits, forestiers, ornementaux)
model Arbre {
  id              Int       @id @default(autoincrement())
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  nom             String    @map("nom") // Nom d'affichage (ex: "Pommier Golden")
  type            String    @map("type") // "fruitier", "petit_fruit", "forestier", "ornement", "haie"
  especeId        String?   @map("espece_id") // Lien optionnel vers le catalogue Espece
  especeRef       Espece?   @relation(fields: [especeId], references: [id], onDelete: SetNull)
  espece          String?   @map("espece") // Espèce texte libre (ex: "Pommier", "Framboisier")
  variete         String?   @map("variete") // Variété (ex: "Golden", "Malling Promise")
  portGreffe      String?   @map("port_greffe") // Porte-greffe si applicable
  fournisseur     String?   @map("fournisseur") // Lieu d'achat / pépinière
  dateAchat       DateTime? @map("date_achat")
  prixAchat       Float?    @map("prix_achat") // Prix d'achat en €
  datePlantation  DateTime? @map("date_plantation")
  age             Int?      @map("age") // Âge à la plantation (années)
  // Position sur le plan
  posX            Float     @map("pos_x")
  posY            Float     @map("pos_y")
  envergure       Float     @default(2) @map("envergure") // Diamètre en mètres (pour affichage)
  // Infos complémentaires
  hauteur         Float?    @map("hauteur") // Hauteur actuelle en mètres
  etat            String?   @map("etat") // "excellent", "bon", "moyen", "mauvais", "mort"
  pollinisateur   String?   @map("pollinisateur") // Variété pollinisatrice associée
  couleur         String?   @map("couleur") // Couleur d'affichage sur le plan
  notes           String?   @map("notes")
  // Gestion production
  productif       Boolean   @default(true) @map("productif") // Est-ce que l'arbre produit ?
  anneeProduction Int?      @map("annee_production") // Première année de production
  rendementMoyen  Float?    @map("rendement_moyen") // kg/an estimé
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations module arbres
  recoltesArbres    RecolteArbre[]
  productionsBois   ProductionBois[]
  operationsArbres  OperationArbre[]

  @@index([userId])
  @@index([type])
  @@index([especeId])
  @@map("arbres")
}

// ============================================================
// MODULE ARBRES - RÉCOLTES, BOIS, OPÉRATIONS
// ============================================================

/// Récoltes d'arbres (fruits, noix, etc.)
model RecolteArbre {
  id             Int       @id @default(autoincrement())
  userId         String    @map("user_id")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  arbreId        Int       @map("arbre_id")
  arbre          Arbre     @relation(fields: [arbreId], references: [id], onDelete: Cascade)
  date           DateTime  @default(now()) @map("date")
  quantite       Float     @map("quantite") // kg
  qualite        String?   @map("qualite") // "excellent", "bon", "moyen", "mauvais"
  prixKg         Float?    @map("prix_kg") // Prix de vente €/kg
  // Statut et vente
  statut         String    @default("en_stock") @map("statut") // "en_stock", "vendu", "consomme", "perte"
  dateVente      DateTime? @map("date_vente")
  prixTotal      Float?    @map("prix_total")
  clientId       Int?      @map("client_id")
  clientNom      String?   @map("client_nom")
  factureId      Int?      @map("facture_id")
  facture        Facture?  @relation("RecolteArbreFacture", fields: [factureId], references: [id])
  datePeremption DateTime? @map("date_peremption")
  notes          String?   @map("notes")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([arbreId])
  @@index([date])
  @@index([statut])
  @@index([factureId])
  @@map("recoltes_arbres")
}

/// Production de bois (élagage, abattage, branchage)
model ProductionBois {
  id          Int       @id @default(autoincrement())
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  arbreId     Int?      @map("arbre_id") // Null si arbre abattu/supprimé
  arbre       Arbre?    @relation(fields: [arbreId], references: [id], onDelete: SetNull)
  date        DateTime  @default(now()) @map("date")
  type        String    @map("type") // "elagage", "abattage", "branchage"
  volumeM3    Float?    @map("volume_m3") // Stères ou m³
  poidsKg     Float?    @map("poids_kg")
  // Statut et destination
  statut      String    @default("en_stock") @map("statut") // "en_stock", "vendu", "utilise"
  destination String?   @map("destination") // "chauffage", "BRF", "vente", "construction"
  // Vente
  dateVente   DateTime? @map("date_vente")
  prixVente   Float?    @map("prix_vente") // € si vendu
  clientId    Int?      @map("client_id")
  clientNom   String?   @map("client_nom")
  factureId   Int?      @map("facture_id")
  facture     Facture?  @relation("ProductionBoisFacture", fields: [factureId], references: [id])
  notes       String?   @map("notes")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([arbreId])
  @@index([date])
  @@index([statut])
  @@index([factureId])
  @@map("production_bois")
}

/// Opérations sur arbres (taille, greffe, traitement, fertilisation)
model OperationArbre {
  id          Int       @id @default(autoincrement())
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  arbreId     Int       @map("arbre_id")
  arbre       Arbre     @relation(fields: [arbreId], references: [id], onDelete: Cascade)
  date        DateTime  @default(now()) @map("date")
  type        String    @map("type") // "taille", "greffe", "traitement", "fertilisation", "autre"
  description String?   @map("description")
  produit     String?   @map("produit") // Produit utilisé
  quantite    Float?    @map("quantite") // Quantité
  unite       String?   @map("unite") // L, kg, etc.
  cout        Float?    @map("cout") // Coût en €
  datePrevue  DateTime? @map("date_prevue") // Date planifiée (si tâche future)
  fait        Boolean   @default(true) @map("fait")
  notes       String?   @map("notes")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([arbreId])
  @@index([type])
  @@index([fait])
  @@map("operations_arbres")
}

// ============================================================
// ASSOCIATIONS DE PLANTES (COMPAGNONNAGE)
// ============================================================

/// Associations de plantes (compagnonnage)
model Association {
  id          String  @id // Ex: "asso-tomate-basilic"
  nom         String  // Ex: "Tomates-Basilic"
  description String?
  notes       String?

  // Relations
  details AssociationDetail[]

  @@map("associations")
}

/// Détails des associations (espèces/familles associées)
model AssociationDetail {
  id            Int          @id @default(autoincrement())
  associationId String       @map("association_id")
  association   Association  @relation(fields: [associationId], references: [id], onDelete: Cascade)
  especeId      String?      @map("espece")
  espece        Espece?      @relation(fields: [especeId], references: [id], onDelete: SetNull)
  familleId     String?      @map("famille")
  famille       Famille?     @relation(fields: [familleId], references: [id], onDelete: SetNull)
  groupe        String?      @map("groupe") // Groupe libre (ex: "Liliacées")
  requise       Boolean      @default(false) @map("requise") // Association requise ou bénéfique
  notes         String?      @map("notes")

  @@index([associationId])
  @@map("associations_details")
}

// ============================================================
// MODULE ÉLEVAGE - GESTION DES ANIMAUX
// ============================================================

/// Espèces animales (référentiel)
model EspeceAnimale {
  id                String    @id @map("espece_animale") // Ex: "poule_pondeuse", "lapin_chair"
  nom               String    @map("nom") // Nom d'affichage
  type              String    @map("type") // "volaille", "mammifere_petit", "mammifere_grand"
  production        String    @map("production") // "oeufs", "viande", "lait", "laine", "mixte"
  dureeGestation    Int?      @map("duree_gestation") // Jours (mammifères)
  dureeCouvaison    Int?      @map("duree_couvaison") // Jours (volailles)
  dureeElevage      Int?      @map("duree_elevage") // Jours jusqu'à maturité/abattage
  poidsAdulte       Float?    @map("poids_adulte") // kg
  rendementCarcasse Float?    @map("rendement_carcasse") // % du poids vif
  ponteAnnuelle     Int?      @map("ponte_annuelle") // Nombre d'œufs/an (pondeuses)
  consommationJour  Float?    @map("conso_jour") // kg aliment/jour
  prixAchat         Float?    @map("prix_achat") // Prix moyen d'achat €
  couleur           String?   @map("couleur") // Couleur UI
  description       String?   @map("description")

  // Relations
  animaux     Animal[]
  lots        LotAnimaux[]

  @@map("especes_animales")
}

/// Aliments pour animaux (similaire à Fertilisant)
model Aliment {
  id            String       @id @map("aliment") // Ex: "granules_pondeuses", "foin"
  nom           String       @map("nom")
  type          String?      @map("type") // "granules", "cereales", "foin", "complement"
  especesCibles String?      @map("especes_cibles") // CSV: "volaille,lapin"
  proteines     Float?       @map("proteines") // % protéines
  energie       Float?       @map("energie") // kcal/kg
  prix          Float?       @map("prix") // €/kg
  stock         Float?       @map("stock") // kg en stock
  dateStock     DateTime?    @map("date_stock")
  stockMin      Float?       @map("stock_min") // Seuil alerte
  fournisseurId String?      @map("fournisseur")
  fournisseur   Fournisseur? @relation(fields: [fournisseurId], references: [id], onDelete: SetNull)
  description   String?      @map("description")

  // Relations
  consommations ConsommationAliment[]
  userStocks    UserStockAliment[]

  @@map("aliments")
}

/// Animaux individuels
model Animal {
  id              Int            @id @default(autoincrement())
  userId          String         @map("user_id")
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  especeAnimaleId String         @map("espece_animale_id")
  especeAnimale   EspeceAnimale  @relation(fields: [especeAnimaleId], references: [id], onDelete: Restrict)
  lotId           Int?           @map("lot_id") // Appartenance à un lot (optionnel)
  lot             LotAnimaux?    @relation(fields: [lotId], references: [id], onDelete: SetNull)
  identifiant     String?        @map("identifiant") // Bague, boucle, puce
  nom             String?        @map("nom")
  race            String?        @map("race") // Race/variété
  sexe            String?        @map("sexe") // "male", "femelle", "inconnu"
  dateNaissance   DateTime?      @map("date_naissance")
  dateArrivee     DateTime?      @map("date_arrivee")
  provenance      String?        @map("provenance") // Éleveur, couvoir, etc.
  prixAchat       Float?         @map("prix_achat")
  statut          String         @default("actif") @map("statut") // "actif", "vendu", "abattu", "mort"
  dateSortie      DateTime?      @map("date_sortie") // Date vente/abattage/mort
  causeSortie     String?        @map("cause_sortie") // Raison de sortie
  // Position sur le plan (optionnel)
  posX            Float?         @map("pos_x")
  posY            Float?         @map("pos_y")
  // Généalogie
  mereId          Int?           @map("mere_id")
  mere            Animal?        @relation("ParentEnfant", fields: [mereId], references: [id], onDelete: SetNull)
  enfants         Animal[]       @relation("ParentEnfant")
  pereIdentifiant String?        @map("pere_identifiant") // Référence texte si père externe
  // Infos complémentaires
  poidsActuel     Float?         @map("poids_actuel") // kg
  couleur         String?        @map("couleur_robe") // Couleur de l'animal
  notes           String?        @map("notes")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  productionsOeufs ProductionOeuf[]
  soins            SoinAnimal[]
  abattages        Abattage[]
  naissancesMere   NaissanceAnimale[] @relation("NaissanceMere")

  @@index([userId])
  @@index([especeAnimaleId])
  @@index([statut])
  @@index([lotId])
  @@index([mereId])
  @@map("animaux")
}

/// Lots d'animaux (gestion par groupe, surtout volailles)
model LotAnimaux {
  id                Int           @id @default(autoincrement())
  userId            String        @map("user_id")
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  especeAnimaleId   String        @map("espece_animale_id")
  especeAnimale     EspeceAnimale @relation(fields: [especeAnimaleId], references: [id], onDelete: Restrict)
  nom               String?       @map("nom") // Ex: "Lot pondeuses 2024"
  dateArrivee       DateTime?     @map("date_arrivee")
  quantiteInitiale  Int           @map("quantite_initiale")
  quantiteActuelle  Int           @map("quantite_actuelle")
  provenance        String?       @map("provenance")
  prixAchatTotal    Float?        @map("prix_achat_total")
  statut            String        @default("actif") @map("statut") // "actif", "reforme", "termine"
  dateReforme       DateTime?     @map("date_reforme")
  notes             String?       @map("notes")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  animaux          Animal[]
  productionsOeufs ProductionOeuf[]
  soins            SoinAnimal[]
  abattages        Abattage[]
  consommations    ConsommationAliment[]

  @@index([userId])
  @@index([especeAnimaleId])
  @@index([statut])
  @@map("lots_animaux")
}

/// Production d'œufs (quotidienne)
model ProductionOeuf {
  id         Int         @id @default(autoincrement())
  userId     String      @map("user_id")
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  lotId      Int?        @map("lot_id")
  lot        LotAnimaux? @relation(fields: [lotId], references: [id], onDelete: SetNull)
  animalId   Int?        @map("animal_id") // Si suivi individuel
  animal     Animal?     @relation(fields: [animalId], references: [id], onDelete: SetNull)
  date       DateTime    @default(now()) @map("date")
  quantite   Int         @map("quantite") // Nombre d'œufs
  casses     Int?        @default(0) @map("casses")
  sales      Int?        @default(0) @map("sales") // Œufs sales
  calibre    String?     @map("calibre") // "petit", "moyen", "gros", "tres_gros"
  notes      String?     @map("notes")
  createdAt  DateTime    @default(now()) @map("created_at")

  @@index([userId])
  @@index([lotId])
  @@index([animalId])
  @@index([date])
  @@map("production_oeufs")
}

/// Ventes de produits (œufs, viande, animaux vivants)
model VenteProduit {
  id            Int          @id @default(autoincrement())
  userId        String       @map("user_id")
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  date          DateTime     @default(now()) @map("date")
  type          String       @map("type") // "oeufs", "viande", "animal_vivant", "lait", "autre"
  description   String?      @map("description") // Ex: "Poulet fermier", "Œufs plein air"
  quantite      Float        @map("quantite")
  unite         String       @map("unite") // "unite", "douzaine", "kg", "L"
  prixUnitaire  Float        @map("prix_unitaire")
  prixTotal     Float        @map("prix_total")
  client        String?      @map("client") // Nom du client
  destinationId String?      @map("destination")
  destination   Destination? @relation(fields: [destinationId], references: [id], onDelete: SetNull)
  factureId     Int?         @map("facture_id")
  facture       Facture?     @relation("VenteProduitFacture", fields: [factureId], references: [id])
  paye          Boolean      @default(true) @map("paye")
  notes         String?      @map("notes")
  createdAt     DateTime     @default(now()) @map("created_at")

  @@index([userId])
  @@index([type])
  @@index([date])
  @@index([factureId])
  @@map("ventes_produits")
}

/// Abattages
model Abattage {
  id           Int         @id @default(autoincrement())
  userId       String      @map("user_id")
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  animalId     Int?        @map("animal_id")
  animal       Animal?     @relation(fields: [animalId], references: [id], onDelete: SetNull)
  lotId        Int?        @map("lot_id")
  lot          LotAnimaux? @relation(fields: [lotId], references: [id], onDelete: SetNull)
  date         DateTime    @default(now()) @map("date")
  quantite     Int         @default(1) @map("quantite") // Nombre d'animaux (si lot)
  poidsVif     Float?      @map("poids_vif") // kg total
  poidsCarcasse Float?     @map("poids_carcasse") // kg total
  destination  String      @map("destination") // "auto_consommation", "vente", "don"
  prixVente    Float?      @map("prix_vente") // € si vendu
  factureId    Int?        @map("facture_id")
  facture      Facture?    @relation("AbattageFacture", fields: [factureId], references: [id])
  lieu         String?     @map("lieu") // "ferme", "abattoir"
  notes        String?     @map("notes")
  createdAt    DateTime    @default(now()) @map("created_at")

  @@index([userId])
  @@index([date])
  @@index([factureId])
  @@map("abattages")
}

/// Consommation d'aliments
model ConsommationAliment {
  id         Int         @id @default(autoincrement())
  userId     String      @map("user_id")
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  alimentId  String      @map("aliment_id")
  aliment    Aliment     @relation(fields: [alimentId], references: [id], onDelete: Restrict)
  lotId      Int?        @map("lot_id")
  lot        LotAnimaux? @relation(fields: [lotId], references: [id], onDelete: SetNull)
  date       DateTime    @default(now()) @map("date")
  quantite   Float       @map("quantite") // kg
  notes      String?     @map("notes")
  createdAt  DateTime    @default(now()) @map("created_at")

  @@index([userId])
  @@index([alimentId])
  @@index([lotId])
  @@index([date])
  @@map("consommations_aliments")
}

/// Soins et traitements des animaux
model SoinAnimal {
  id          Int         @id @default(autoincrement())
  userId      String      @map("user_id")
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  animalId    Int?        @map("animal_id")
  animal      Animal?     @relation(fields: [animalId], references: [id], onDelete: SetNull)
  lotId       Int?        @map("lot_id")
  lot         LotAnimaux? @relation(fields: [lotId], references: [id], onDelete: SetNull)
  date        DateTime    @default(now()) @map("date")
  type        String      @map("type") // "vaccination", "vermifuge", "traitement", "autre"
  description String?     @map("description")
  produit     String?     @map("produit") // Produit utilisé
  quantite    Float?      @map("quantite")
  unite       String?     @map("unite")
  cout        Float?      @map("cout") // €
  veterinaire String?     @map("veterinaire") // Nom du véto si applicable
  datePrevue  DateTime?   @map("date_prevue") // Rappel planifié
  fait        Boolean     @default(true) @map("fait")
  notes       String?     @map("notes")
  createdAt   DateTime    @default(now()) @map("created_at")

  @@index([userId])
  @@index([animalId])
  @@index([lotId])
  @@index([type])
  @@index([fait])
  @@map("soins_animaux")
}

/// Naissances d'animaux
model NaissanceAnimale {
  id            Int       @id @default(autoincrement())
  userId        String    @map("user_id")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mereId        Int?      @map("mere_id")
  mere          Animal?   @relation("NaissanceMere", fields: [mereId], references: [id], onDelete: SetNull)
  pereIdentifiant String? @map("pere_identifiant") // Référence si père connu
  date          DateTime  @default(now()) @map("date")
  nombreNes     Int       @map("nombre_nes")
  nombreVivants Int       @map("nombre_vivants")
  nombreMales   Int?      @map("nombre_males")
  nombreFemelles Int?     @map("nombre_femelles")
  poidsTotal    Float?    @map("poids_total") // kg total portée
  notes         String?   @map("notes")
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([mereId])
  @@index([date])
  @@map("naissances_animales")
}

// ============================================================
// MODULE COMPTABILITÉ
// ============================================================

/// Ventes manuelles (légumes, services, etc. - non trackées ailleurs)
// ============================================================
// COMPTABILITÉ - CLIENTS & FACTURES
// ============================================================

/// Clients (acheteurs)
model Client {
  id                 Int      @id @default(autoincrement())
  userId             String   @map("user_id")
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  nom                String   @map("nom")
  type               String   @default("particulier") @map("type") // "particulier", "professionnel", "association", "amap"
  email              String?  @map("email")
  telephone          String?  @map("telephone")
  adresse            String?  @map("adresse")
  ville              String?  @map("ville")
  codePostal         String?  @map("code_postal")
  pays               String?  @default("France") @map("pays")
  siret              String?  @map("siret") // Pour professionnels
  tvaIntra           String?  @map("tva_intra") // Numéro TVA intracommunautaire
  conditionsPaiement Int?     @default(0) @map("conditions_paiement") // Délai paiement en jours (0 = comptant)
  exonererTVA        Boolean  @default(false) @map("exonerer_tva") // Client exonéré de TVA
  notes              String?  @map("notes")
  actif              Boolean  @default(true) @map("actif")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  ventesManuelles VenteManuelle[]
  factures        Facture[]

  @@index([userId])
  @@index([nom])
  @@map("clients")
}

/// Factures émises
model Facture {
  id              Int       @id @default(autoincrement())
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  numero          String    @map("numero") // F-2026-0001
  type            String    @default("facture") @map("type") // "facture", "avoir", "acompte"
  clientId        Int?      @map("client_id")
  client          Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  clientNom       String    @map("client_nom") // Copie pour archivage
  clientAdresse   String?   @map("client_adresse")
  date            DateTime  @default(now()) @map("date")
  dateEcheance    DateTime? @map("date_echeance")
  objet           String?   @map("objet")
  // Montants
  totalHT         Float     @map("total_ht")
  totalTVA        Float     @default(0) @map("total_tva")
  totalTTC        Float     @map("total_ttc")
  // Statut
  statut          String    @default("emise") @map("statut") // "brouillon", "emise", "payee", "annulee"
  datePaiement    DateTime? @map("date_paiement")
  modePaiement    String?   @map("mode_paiement") // "especes", "cheque", "cb", "virement"
  // Référence avoir
  factureOrigineId Int?     @map("facture_origine_id") // Pour les avoirs
  notes           String?   @map("notes")
  mentionsLegales String?   @map("mentions_legales")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  lignes           LigneFacture[]
  ventesProduits   VenteProduit[]   @relation("VenteProduitFacture")
  abattages        Abattage[]       @relation("AbattageFacture")
  recoltesArbres   RecolteArbre[]   @relation("RecolteArbreFacture")
  productionsBois  ProductionBois[] @relation("ProductionBoisFacture")

  @@unique([userId, numero])
  @@index([userId])
  @@index([clientId])
  @@index([date])
  @@index([statut])
  @@map("factures")
}

/// Lignes de facture
model LigneFacture {
  id           Int     @id @default(autoincrement())
  factureId    Int     @map("facture_id")
  facture      Facture @relation(fields: [factureId], references: [id], onDelete: Cascade)
  ordre        Int     @default(0) @map("ordre")
  description  String  @map("description")
  quantite     Float   @map("quantite")
  unite        String  @default("unité") @map("unite")
  prixUnitaire Float   @map("prix_unitaire") // HT
  tauxTVA      Float   @default(5.5) @map("taux_tva") // 5.5, 10, 20
  montantHT    Float   @map("montant_ht")
  montantTVA   Float   @map("montant_tva")
  montantTTC   Float   @map("montant_ttc")

  @@index([factureId])
  @@map("lignes_factures")
}

// ============================================================
// COMPTABILITÉ - VENTES & DÉPENSES MANUELLES
// ============================================================

model VenteManuelle {
  id           Int      @id @default(autoincrement())
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date         DateTime @default(now()) @map("date")
  categorie    String   @map("categorie") // "legumes", "fruits", "transformation", "service", "autre"
  description  String   @map("description")
  quantite     Float?   @map("quantite")
  unite        String?  @map("unite") // kg, unite, heure
  prixUnitaire Float?   @map("prix_unitaire")
  // Montants avec TVA
  tauxTVA      Float    @default(5.5) @map("taux_tva") // 5.5%, 10%, 20%
  montantHT    Float?   @map("montant_ht")
  montantTVA   Float?   @map("montant_tva")
  montant      Float    @map("montant") // Total TTC en €
  // Client
  clientId     Int?     @map("client_id")
  client       Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  clientNom    String?  @map("client_nom") // Nom client (si pas de fiche client)
  module       String?  @map("module") // "potager", "verger", "elevage", "general"
  paye         Boolean  @default(true) @map("paye")
  notes        String?  @map("notes")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([clientId])
  @@index([date])
  @@index([categorie])
  @@map("ventes_manuelles")
}

/// Dépenses manuelles (matériel, carburant, etc. - non trackées ailleurs)
model DepenseManuelle {
  id             Int      @id @default(autoincrement())
  userId         String   @map("user_id")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date           DateTime @default(now()) @map("date")
  categorie      String   @map("categorie") // "materiel", "carburant", "main_oeuvre", "abonnement", "autre"
  description    String   @map("description")
  // Montants avec TVA
  tauxTVA        Float    @default(20) @map("taux_tva") // 5.5%, 10%, 20%
  montantHT      Float?   @map("montant_ht")
  montantTVA     Float?   @map("montant_tva") // TVA déductible
  montant        Float    @map("montant") // Total TTC en €
  module         String?  @map("module") // "potager", "verger", "elevage", "general"
  // Fournisseur
  fournisseurId  String?  @map("fournisseur_id")
  fournisseurNom String?  @map("fournisseur_nom") // Nom fournisseur (si pas de fiche)
  refFacture     String?  @map("ref_facture") // Référence facture fournisseur
  paye           Boolean  @default(true) @map("paye")
  dateEcheance   DateTime? @map("date_echeance")
  notes          String?  @map("notes")
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([fournisseurId])
  @@index([date])
  @@index([categorie])
  @@map("depenses_manuelles")
}

// ============================================================
// STOCKS PER-USER (MULTI-TENANCY)
// ============================================================

/// Stock de variétés par utilisateur (graines + plants)
model UserStockVariete {
  id           Int       @id @default(autoincrement())
  userId       String    @map("user_id")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  varieteId    String    @map("variete_id")
  variete      Variete   @relation(fields: [varieteId], references: [id], onDelete: Cascade)
  stockGraines Float?    @map("stock_graines") // g
  stockPlants  Int?      @map("stock_plants")
  dateStock    DateTime? @map("date_stock")

  @@unique([userId, varieteId])
  @@index([userId])
  @@index([varieteId])
  @@map("user_stock_varietes")
}

/// Stock de fertilisants par utilisateur
model UserStockFertilisant {
  id            Int       @id @default(autoincrement())
  userId        String    @map("user_id")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  fertilisantId String    @map("fertilisant_id")
  fertilisant   Fertilisant @relation(fields: [fertilisantId], references: [id], onDelete: Cascade)
  stock         Float?    @map("stock") // kg ou L
  dateStock     DateTime? @map("date_stock")
  prix          Float?    @map("prix") // €/kg (prix per-user)

  @@unique([userId, fertilisantId])
  @@index([userId])
  @@index([fertilisantId])
  @@map("user_stock_fertilisants")
}

/// Stock d'aliments par utilisateur
model UserStockAliment {
  id        Int       @id @default(autoincrement())
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  alimentId String    @map("aliment_id")
  aliment   Aliment   @relation(fields: [alimentId], references: [id], onDelete: Cascade)
  stock     Float?    @map("stock") // kg
  dateStock DateTime? @map("date_stock")
  stockMin  Float?    @map("stock_min") // seuil alerte
  prix      Float?    @map("prix") // €/kg

  @@unique([userId, alimentId])
  @@index([userId])
  @@index([alimentId])
  @@map("user_stock_aliments")
}

/// Inventaire d'espèces par utilisateur (récoltes en stock)
model UserStockEspece {
  id             Int       @id @default(autoincrement())
  userId         String    @map("user_id")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  especeId       String    @map("espece_id")
  espece         Espece    @relation(fields: [especeId], references: [id], onDelete: Cascade)
  inventaire     Float?    @map("inventaire") // kg
  dateInventaire DateTime? @map("date_inventaire")
  prixKg         Float?    @map("prix_kg") // €/kg
  objectifAnnuel Float?    @map("obj_annuel") // kg ou unités visées/an

  @@unique([userId, especeId])
  @@index([userId])
  @@index([especeId])
  @@map("user_stock_especes")
}

// ============================================================
// CHAT IA (Assistant Ollama)
// ============================================================

/// Conversations de chat IA
model Conversation {
  id        String        @id @default(cuid())
  userId    String        @map("user_id")
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String?
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  messages  ChatMessage[]

  @@index([userId])
  @@index([updatedAt])
  @@map("conversations")
}

/// Messages de chat IA
model ChatMessage {
  id             Int          @id @default(autoincrement())
  conversationId String       @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String       // "user", "assistant", "tool"
  content        String       @db.Text
  toolCalls      Json?        @map("tool_calls")
  toolResults    Json?        @map("tool_results")
  createdAt      DateTime     @default(now()) @map("created_at")

  @@index([conversationId])
  @@map("chat_messages")
}
